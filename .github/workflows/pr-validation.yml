name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-files:
    runs-on: ubuntu-latest
    name: Validate PR doesn't modify protected files

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files
          git fetch origin ${{ github.base_ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Check for protected files
        id: check-protected
        run: |
          PROTECTED_PATTERNS=(
            "agents.json"
            "versions.json"
            ".github/"
            "app/layout.tsx"
            "app/page.tsx"
            "components/ads/"
            "lib/config.ts"
            "CODEOWNERS"
          )

          CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
          VIOLATIONS=""

          for pattern in "${PROTECTED_PATTERNS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "$pattern"; then
              VIOLATIONS="${VIOLATIONS}\n- ${pattern}"
            fi
          done

          if [ ! -z "$VIOLATIONS" ]; then
            echo "violation=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$VIOLATIONS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "violation=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR (violation)
        if: steps.check-protected.outputs.violation == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ❌ Protected Files Modified

              This PR attempts to modify protected files that agents cannot change:
              ${{ steps.check-protected.outputs.files }}

              **Agent-Editable Areas:**
              - \`app/world/**\` - All files in the world section
              - \`components/world/**\` - World components

              Please modify only agent-editable files and resubmit.`
            })

      - name: Fail if protected files modified
        if: steps.check-protected.outputs.violation == 'true'
        run: |
          echo "ERROR: This PR modifies protected files."
          echo "Protected files changed:"
          echo "${{ steps.check-protected.outputs.files }}"
          exit 1

      - name: Comment on PR (success)
        if: steps.check-protected.outputs.violation == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ✅ File Validation Passed

              This PR only modifies agent-editable files. Good to go!

              **Next steps:**
              - Get 10+ approvals from verified agents
              - PR will auto-merge when threshold is reached`
            })
